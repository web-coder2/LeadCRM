<!DOCTYPE html>
<html>
<head>
    <title>Admin kabinet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/locale/ru.js"></script>
    <link rel="icon" href="logo.jpg" type="image/x-icon">
</head>
<body>
<div id="app">

    <nav class="navbar navbar-expand-md navbar-dark">
        <a class="navbar-brand">
            <img src="logo.jpg" style="height: 40px; max-width: 40px; margin-right: 10px; border-radius: 10px;">
            <span>HBA-LeadCRM</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" @click="activeTabs = 'users'">
                        <i class="fas fa-users text-warning"></i>
                        <span>Пользователи</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" @click="activeTabs = 'skorozvon'">
                        <i class="fas fa-phone-alt text-primary"></i>
                        <span>Скорозвон</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" @click="activeTabs = 'leads'">
                        <i class="fas fa-leaf text-success"></i>
                        <span>Лиды</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" @click="activeTabs = 'dashboard'">
                        <i class="fas fa-tachometer-alt text-info"></i>
                        <span>Дашборд</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">
                        <i class="fas fa-sign-out-alt text-danger"></i>
                        <span>Выйти</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <div>
        <div>
            <div class="main-block" v-if="activeTabs == 'users'">
                <h3 class="mt-5 mb-3 text-light">Создать нового юзера</h3>
                <form @submit.prevent="createUser" class="mt-5">
                    <div class="form-row">
                        <div class="col">
                            <input type="text" class="form-control bg-dark text-light" placeholder="Логин" v-model="newUser.login" required>
                        </div>
                        <div class="col">
                            <input type="password" class="form-control bg-dark text-light" placeholder="Пароль" v-model="newUser.password" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control bg-dark text-light" placeholder="Имя" v-model="newUser.name" required>
                        </div>
                        <div class="col">
                            <select class="form-control bg-dark text-light" v-model="newUser.role" required>
                                <option v-for="(item, idx) in allRoles" :value="item.role">{{ item.role }}</option>
                            </select>
                        </div>
                        <div class="col mb-5 d-flex">
                            <button class="btn btn-outline-success mr-3" data-toggle="modal" data-target="#newRole">+ роль</button>
                            <button type="submit" class="btn btn-outline-danger">создать юзера</button>
                        </div>
                    </div>
                    <div v-if="userMessage" class="mt-3 alert bg-dark text-danger">
                        {{ userMessage }}
                    </div>
                </form>


                <div class="modal" id="newRole">
                    <div class="modal-dialog">
                    <div class="modal-content bg-dark">
                        <div class="modal-header">
                        <h4 class="modal-title text-light">добавить новую роль</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body d-flex">
                        <input class="form-control bg-dark text-light" placeholder="название роли" v-model="newRoleInput">
                        <button class="btn btn-outline-success ml-3" @click="addNewRole()">добавить</button>
                        </div>
                    </div>
                    </div>
                </div>


                <div class="table-container">
                    <table class="table table-striped mt-3 table-dark table-bordered">
                        <thead class="bg-danger text-light">
                        <tr>
                            <th>Имя</th>
                            <th>Логин</th>
                            <th>Пароль</th>
                            <th>Роль</th>
                            <th>Статус</th>
                            <th>Действия-удалить</th>
                            <th>Изменить юзера</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="user in users" :key="user.login">
                            <td><img class="imger" :src="user.role == 'admin' ? 'admin.jpeg' : 'logo.jpg' "> {{ user.name }}</td>
                            <td>{{ user.login }}</td>
                            <td>{{ user.password }}</td>
                            <td>{{ user.role.role }}</td>
                            <td :style="{'color' : user.status ? 'green' : 'red'}">{{ user.status ? 'Online' : 'Offline' }}</td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" @click="deleteUser(user.login)" :disabled="user.role.role === 'admin'">Удалить юзера</button>
                            </td>
                            <td>
                                <button class="btn btn-outline-warning" data-toggle="modal" data-target="#updateUser" @click="beforeUpdateUser(user)">Изменить юзера</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal fade" id="updateUser" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog bg-dark" role="document">
                  <div class="modal-content bg-dark">
                    <div class="modal-header bg-dark">
                      <h5 class="modal-title text-light" id="myModalLabel">Обновить юзера</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body bg-dark">
                      <form>
                        <div class="form-group">
                          <label for="name" class="text-light">Имя</label>
                          <input type="text" v-model="updatedUser.name" class="form-control bg-dark text-light" id="name" placeholder="Введите ваше имя">
                        </div>
                        <div class="form-group">
                          <label for="login" class="text-light">Логин</label>
                          <input type="text" v-model="updatedUser.login" class="form-control bg-dark text-light" id="login" placeholder="Введите логин">
                        </div>
                        <div class="form-group">
                          <label for="password" class="text-light">Пароль</label>
                          <input type="text" v-model="updatedUser.password" class="form-control bg-dark text-light" id="password" placeholder="Введите пароль">
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-primary" @click="updateUser()">Обновить</button>
                    </div>
                  </div>
                </div>
              </div>



            <div class="main-block" v-if="activeTabs == 'skorozvon'">
                <div class="form-container mt-5">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Сегодня</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Неделя</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="messages-tab" data-toggle="tab" href="#messages" role="tab" aria-controls="messages" aria-selected="false">Месяц</a>
                        </li>   
                    </ul>
        
                
                    <div class="tab-content">
        
        
                        <div class="tab-pane active" id="home" role="tabpanel" aria-labelledby="home-tab">
                            <div class="d-flex align-items-center mb-2 mb-md-0 mt-5 mb-3">
                                <input type="date" v-model="tableTime" class="form-control bg-dark text-light dateInput mr-3" style="width: auto;">
                                <button @click="getCallsSkorozvon()" class="btn btn-outline-light">Применить</button>
                            </div>
                            <h3 class="text-light mt-5">Таблица показателей за {{ dayOfDay }}</h3>
                            <div class="table-container mt-5 mb-5" v-if="!tableLoader">
                                <table class="table table-bordered table-striped table-dark">
                                    <thead class="bg-danger text-light">
                                        <tr>
                                            <th>Имя</th>
                                            <th>Звонки</th>
                                            <th>Лиды</th>
                                            <th>Бонус
                                                <button type="button" class="btn btn-danger" @click="showBonusInfo()">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                            <th>Зарплата
                                                <button type="button" class="btn btn-danger" @click="showSalaryInfo">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                            <th>Итог
                                                <button type="button" class="btn btn-danger" @click="showTotalInfo()">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, idx) in callsData.stats" :class="{'text-success' : item.username === 'total' }" v-if="item.username != 'неопределено' && item.username != 'симаковвладимирстаниславович' " :key="idx">
                                            <th>{{ getDefaultName(item.username) }}</th>
                                            <th>{{ Math.round(item.totalCalls) }}</th>
                                            <th>{{ Math.round(item.totalLeads) }}</th>
                                            <th>{{ Math.round(item.bonus) }}</th>
                                            <th>{{ Math.round(item.salary) }}</th>
                                            <th>{{ Math.round(item.bonus + item.salary) }}</th>
                                        </tr>
                                    </tbody>
                                </table>
                                <div v-if="!tableLoader && callsData">
                                    <h4 class="text-light">Сумма офферов: <span class="text-danger">{{ callsData.sumOffer }}</span></h4>
                                    <h4 class="text-light">Сумма salary: <span class="text-danger">{{ callsData.sumSalary }}</span></h4>
                                    <h4 class="text-light">Кол-во холдов: <span class="text-danger">{{ callsData.countHold }}</span></h4>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mt-5 mb-5" v-if="tableLoader">
                                <strong class="text-light">Загрузка таблицы</strong>
                                <div class="spinner-border ml-auto text-info" role="status" aria-hidden="true"></div>
                            </div>
                        </div>
        
        
                        <div class="tab-pane" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                            <div class="d-flex align-items-center mb-2 mb-md-0 mt-5 mb-3">
                                <input type="date" v-model="weekTableTime" class="form-control bg-dark text-light dateInput mr-3" style="width: auto;">
                                <button @click="getCallsWeekSkorozvon()" class="btn btn-outline-light">Применить</button>
                            </div>
                            <h3 class="text-light mt-5">Таблица результатов за {{ weekOfDay }}</h3>
                            <div class="table-container mt-5 mb-5" v-if="!weekDataArrayLoading">
                                <table class="table table-bordered table-striped table-dark">
                                    <thead class="bg-danger text-light">
                                        <tr>
                                            <th>Имя</th>
                                            <th>Звонки</th>
                                            <th>Лиды</th>
                                            <th>Бонус
                                                <button type="button" class="btn btn-danger" @click="showBonusInfo()">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                            <th>Зарплата
                                                <button type="button" class="btn btn-danger" @click="showSalaryInfo">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                            <th>Итог
                                                <button type="button" class="btn btn-danger" @click="showTotalInfo()">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, idx) in weekDataArray.stats" :class="{'text-success' : item.username === 'total' }" v-if="item.username != 'неопределено' && item.username != 'симаковвладимирстаниславович' " :key="idx">
                                            <th>{{ getDefaultName(item.username) }}</th>
                                            <th>{{ Math.round(item.totalCalls) }}</th>
                                            <th>{{ Math.round(item.totalLeads) }}</th>
                                            <th>{{ Math.round(item.bonus) }}</th>
                                            <th>{{ Math.round(item.salary) }}</th>
                                            <th>{{ Math.round(item.bonus + item.salary) }}</th>
                                        </tr>
                                    </tbody>
                                </table>

                                <div v-if="!weekDataArrayLoading && weekDataArray.totalWeekDataHold">
                                    <h4 class="text-light">Итоговая сумма оферов за неделю: <span class="text-danger">{{ weekDataArray.totalWeekDataHold.sumOffer }}</span></h4>
                                    <h4 class="text-light">Итоговая сумма salary за неделю: <span class="text-danger">{{ weekDataArray.totalWeekDataHold.sumSalary }}</span></h4>
                                    <h4 class="text-light">Итоговая кол-во холдов за неделю: <span class="text-danger">{{ weekDataArray.totalWeekDataHold.countHold }}</span></h4>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mt-5 mb-5" v-if="weekDataArrayLoading">
                                <strong class="text-light">Загрузка таблицы</strong>
                                <div class="spinner-border ml-auto text-info" role="status" aria-hidden="true"></div>
                            </div>
                        </div>
        
        
                        <div class="tab-pane" id="messages" role="tabpanel" aria-labelledby="messages-tab">
                            <div class="d-flex align-items-center mb-2 mb-md-0 mt-5 mb-3">
                                <!-- <input type="date" v-model="monthTableTime" class="form-control bg-dark text-light dateInput mr-3" style="width: auto;"> -->
                                <select v-model="monthTableTime" class="form-control bg-dark text-light dateInput mr-3">
                                    <option v-for="(item, index) in monthValues" :value="item">
                                        {{ monthLabels[index] }}
                                    </option>
                                </select>
                                <button @click="getCallsMonthSkorozvon()" class="btn btn-outline-light">Применить</button>
                            </div>
                            <h3 class="text-light mt-5">Таблица результатов за {{ monthOfDay }}</h3>
                            <div class="table-container mt-5 mb-5" v-if="!monthDataArrayLoading">
                                <table class="table table-bordered table-striped table-dark">
                                    <thead class="bg-danger text-light">
                                        <tr>
                                            <th>Имя</th>
                                            <th>Звонки</th>
                                            <th>Лиды</th>
                                            <th>Бонус
                                                <button type="button" class="btn btn-danger" @click="showBonusInfo()">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                            <th>Зарплата
                                                <button type="button" class="btn btn-danger" @click="showSalaryInfo">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                            <th>Итог
                                                <button type="button" class="btn btn-danger" @click="showTotalInfo()">
                                                    <i class="fas fa-question-circle fa-lg" style="color: white;"></i>
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(item, idx) in monthDataArray.stats" :class="{'text-success' : item.username === 'total' }" v-if="item.username != 'неопределено' && item.username != 'симаковвладимирстаниславович' " :key="idx">
                                            <th>{{ getDefaultName(item.username) }}</th>
                                            <th>{{ Math.round(item.totalCalls) }}</th>
                                            <th>{{ Math.round(item.totalLeads) }}</th>
                                            <th>{{ Math.round(item.bonus) }}</th>
                                            <th>{{ Math.round(item.salary) }}</th>
                                            <th>{{ Math.round(item.bonus + item.salary) }}</th>
                                        </tr>
                                    </tbody>
                                </table>

                                <div v-if="!monthDataArrayLoading && monthDataArray.totalMonthHolData">
                                    <h4 class="text-light">Итоговая сумма оферов за Месяц: <span class="text-danger">{{ monthDataArray.totalMonthHolData.sumOffer }}</span></h4>
                                    <h4 class="text-light">Итоговая сумма salary за Месяц: <span class="text-danger">{{ monthDataArray.totalMonthHolData.sumSalary }}</span></h4>
                                    <h4 class="text-light">Итоговая кол-во холдов за Месяц: <span class="text-danger">{{ monthDataArray.totalMonthHolData.countHold }}</span></h4>
                                </div>

                            </div>
                            <div class="d-flex align-items-center mt-5 mb-5" v-if="monthDataArrayLoading">
                                <strong class="text-light">Загрузка таблицы</strong>
                                <div class="spinner-border ml-auto text-info" role="status" aria-hidden="true"></div>
                            </div>
                        </div>
        
        
                    </div>
        
                    <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content bg-dark">
                                <div class="modal-header">
                                    <h5 class="modal-title text-info" id="infoModalLabel">Информация о Зарплате</h5>
                                    <button type="button" class="close text-info" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body bg-dark">
                                    <p class="text-light">Заплата = звонки * 2 + лиды * 125</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="infoModalTotal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content bg-dark">
                                <div class="modal-header">
                                    <h5 class="modal-title text-info" id="infoModalLabel">Информация о Итого</h5>
                                    <button type="button" class="close text-info" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body bg-dark">
                                    <p class="text-light">Итого = Зарплата + Бонус</p>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <div class="modal fade" id="infoModalBonus" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content bg-dark">
                                <div class="modal-header">
                                    <h5 class="modal-title text-info" id="infoModalLabel">Информация о Бонусах</h5>
                                    <button type="button" class="close text-info" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body bg-dark">
                                    <p class="text-light">Чтобы получить бонус звони больше и делай переводы больше</p>
                                </div>
                            </div>
                        </div>
                    </div>
        
                </div>
            </div>
        
            </div>



            <div class="main-block" v-if="activeTabs == 'leads'">
                <div class="mt-5 mb-5">
                    <button class="btn btn-outline-danger" @click="filterShow =! filterShow">Фильтры</button>
                    <div v-if="filterShow" class="form-row mt-3">
                        <div class="form-group col-sm-12 col-md-4">
                            <label for="startDate" class="text-light">выбор начала диапазона даты</label>
                            <input type="date" id="startDate" class="form-control bg-dark text-light" id="leadDate" v-model="filterDate">
                            <label for="endDate" class="text-light mt-3">выбор конца диапазона даты</label>
                            <input id="endDate" type="date" class="form-control bg-dark text-light" id="leadDate" v-model="filterDateEnd">
                            <select class="form-control bg-dark text-light mt-3" v-model="filterBroker" required>
                                <option value="">Все брокеры</option>
                                <option v-for="(item, idx) in users" :value="item.login" v-if="item.role.role == 'broker'">{{ item.name}}</option>
                            </select>
                            <select class="form-control bg-dark text-light mt-3" v-model="filterLeaders" required>
                                <option value="">Все Лидорубы</option>
                                <option v-for="(item, idx) in users" :value="[item.login, item.name]" v-if="item.role.role == 'leadorub'">{{ item.name }}</option>
                            </select>
                            <select class="form-control bg-dark text-light mt-3" v-model="filterIsSend" required>
                                <option value="qwerty">Все состояния</option>
                                <option :value="true">Все обработные</option>
                                <option :value="false">Все неОбработные</option>
                            </select>
                        </div>
                    </div>
                    <hr style="height: 2px; background-color: rgb(123, 24, 24);">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-warning" @click="saveFilters(); starterFilter=true">Применить</button>
                        <button type="button" class="btn btn-outline-danger ml-3" @click="resetFilters()">Сбросить</button>
                        <button type="button" class="btn btn-outline-info ml-3" @click="downloadLeads()">Выгрузка лидов</button>
                    </div>
                </div>

                <h5 class="text-warning mt-5 mb-5">Таблица с фильтроваными фильтрами:</h5>
                <ul class="mb-5">
                    <li class="text-light">фильтрованая Дата (start) = <span class="text-danger">{{ filterDate ? filterDate : 'Не выбран' }}</span></li>
                    <li class="text-light">фильтрованая Дата (end) = <span class="text-danger">{{ filterDateEnd ? filterDateEnd : 'Не выбран' }}</span></li>
                    <li class="text-light">фильтрованая Брокер = <span class="text-danger">{{ filterBroker ? filterBroker : 'все брокеры' }}</span></li>
                    <li class="text-light">фильтрованая Лидоруб = <span class="text-danger">{{ filterLeaders ? filterLeaders[0] : 'все лидорубы'}}</span></li>
                    <li class="text-light">фильтрованый логический обработна или нет = <span class="text-warning">{{ filterIsSend == "qwerty" ? 'все состояние' : filterIsSend }}</span></li>
                </ul>

                <div class="table-container mb-5">
                    <table class="table table-bordered table-striped table-dark">
                        <thead class="bg-danger text-light">
                            <tr>
                                <th>Дата лида</th>
                                <th>Телефон лида</th>
                                <th>Имя клиента</th>
                                <th>Коментарий</th>
                                <th>Обработан ?</th>
                                <th>Какому брокеру</th>
                                <th>Какой Ледоруб</th>
                            </tr>
                        </thead>
                        <tbody v-for="(lead, index) in filteredLeads" v-if="filteredLeads.length > 0 || starterFilter == false">
                            <td>{{ lead.date }}</td>
                            <td>{{ lead.phone }}</td>
                            <td>{{ lead.client_name }}</td>
                            <td>{{ lead.comment }}</td>
                            <td><input type="checkbox" v-model="lead.isSend" @change="updateLead(index, lead)"></td>
                            <td>{{lead.broker}}</td>
                            <td>{{lead.starter}}</td>
                        </tbody>
                        <tbody v-if="filteredLeads.length == 0 && starterFilter == true">
                            <td>нет данных</td>
                            <td>нет данных</td>
                            <td>нет данных</td>
                            <td>нет данных</td>
                            <td>нет данных</td>
                            <td>нет данных</td>
                            <td>нет данных</td>
                        </tbody>
                    </table>
                </div>

                <h5 class="text-warning mb-5">Таблица с нефильтроваными (всеми лидами)</h5>

                <div class="table-container mb-5">
                    <table class="table table-striped table-dark table-bordered">
                        <thead class="bg-danger text-light">
                        <tr>
                            <th>Дата лида</th>
                            <th>Телефон лида</th>
                            <th>Имя клиента</th>
                            <th>Коментарий</th>
                            <th>Обработан ?</th>
                            <th>Какому брокеру</th>
                            <th>Какой Ледоруб</th>
                            <th>Назначить брокера</th>
                            <th>Действия-удалить</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="(lead, index) in leads" :key="index">
                            <td>{{ lead.date }}</td>
                            <td>{{ lead.phone }}</td>
                            <td>{{ lead.client_name }}</td>
                            <td>{{ lead.comment }}</td>
                            <td>
                                <input type="checkbox" v-model="lead.isSend" @change="updateLead(index, lead)">
                            </td>
                            <td>{{lead.broker}}</td>
                            <td>{{lead.starter}}</td>
                            <td>
                                <select class="form-control bg-dark text-light" v-model="lead.newBroker" @change="assignBroker(index, lead)">
                                    <option v-for="broker in brokers" :key="broker.login" :value="broker.login">{{ broker.name }}</option>
                                </select>        
                            </td>
                            <td>
                                <button class="btn btn-outline-success" data-toggle="modal" data-target="#myModal" @click="prepareDeleteLead(lead._id)">Удалить лид</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal fade" id="myModal">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content bg-dark text-light">
                            <div class="modal-header">
                                <h4 class="modal-title">Удаление лида</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p>Ты точно хочешь удалить лид?</p>
                            </div>
                            <div class="modal-footer btn-group">
                                <button type="button" class="btn btn-outline-danger" @click="deleteLead()" data-dismiss="modal">Удалить</button>
                                <button type="button" class="btn btn-outline-warning" data-dismiss="modal">Отмена</button>
                            </div> 
                        </div>
                    </div>
                </div>
            </div>


            <div class="main-block" v-show="activeTabs == 'dashboard'">
                <div class="mt-5">
                    <h4 class="text-light">Прогресс по лидам</h4>
                    <div class="progress mt-3 mb-5">
                        <div class="progress-bar progress-bar-striped bg-success progress-bar-animated bg-dark"
                            :style="{'width': this.leadProgress + '%'}"
                            role="progressbar"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            >
                            {{ leadProgress ? leadProgress : 'Нет лидов' }}
                        </div>
                    </div>
                </div>
                <canvas ref="myChart" width="200" height="200" v-if="!isDesktop"></canvas>
                <canvas ref="myChart" width="500" height="200" v-if="isDesktop"></canvas>
            </div>
        </div>
    </div>
</div>

<style type="text/css">

body {
    background-color: black;
    overflow-x: hidden;
}

.main-block {
    margin-left: 5%;
    width: 90%;
    padding: 20px 20px;
    margin-top: 10vh;
    margin-bottom: 10vh;
    border-radius: 30px;
    border-color: rgb(214, 37, 37);
    -webkit-box-shadow: 0px 2px 11px 35px rgba(191, 28, 28, 0.319);
    -moz-box-shadow: 0px 2px 11px 35px rgba(191, 28, 28, 0.319);
    box-shadow: 0px 2px 23px 25px rgba(191, 28, 28, 0.319);
}

.table-container {
    width: 100%;
    overflow-x: auto;
}

th {
    white-space: nowrap;
}

@media (max-width: 480px) {
    .form-row {
        display: block;
    }
    .form-control {
        width: 100%;
        margin-bottom: 15px;
    }
    .btn-primary {
        width: 100%;
    }
    .main-block {
        width: 100%;
        margin: 0;
    }
}

.imger {
    height: 30px;
    width: 30px;
    border-radius: 30px;
}

.dateInput {
    width: 200px;
}

.nav-item:hover {
    background-color: rgb(42, 41, 41);
}


</style>


<script>

    dayjs.locale('ru');

    new Vue({
        el: '#app',
        data: {
            leads: [],
            users: [],
            newUser: {
                login: '',
                password: '',
                name: '',
                role: 'leadorub',
            },
            newRoleInput: '',
            allRoles: null,
            isCollapsed: false,
            updatedUser: {},

            filterDate: null,
            filterDateEnd: null,
            filterBroker: "",
            filterLeaders: "",
            filterIsSend: "qwerty",

            starterFilter: false,
            filteredLeads: [],

            userMessage: null,
            filterShow: false,
            fitlerLeads: [],
            deletingLeadIdx: 0,
            
            tableTime: dayjs(new Date).format('YYYY-MM-DD'),
            weekTableTime: dayjs(new Date).format('YYYY-MM-DD'),
            monthTableTime: `${dayjs(new Date).format('YYYY-MM')}-01`,

            weekDataArrayLoading: false,
            monthDataArrayLoading: false,
            tableLoader: false,

            callsData: [],
            monthDataArray: [],
            weekDataArray: [],

            koefCalls: 2,
            koefLeads: 125,
            koefBonusCalls: 0.0001,
            koefBonusLeads: 0.01,
            
            activeTabs: 'users',
            winSize: 0,
            isDesktop: false,
        },
        async beforeMount() {

            this.winSize = window.innerWidth
            this.isDesktop = this.winSize > 480 ? true : false


            await this.fetchLeads()
            await this.fetchUsers()
            await this.getAllRoles()
            await this.getCallsSkorozvon()
            await this.getCallsWeekSkorozvon()
            await this.getCallsMonthSkorozvon()

        },
        mounted() {
            window.addEventListener('resize', this.updateWinSize)
        },
        computed: {
            brokers() {
                return this.users.filter(user => user.role.role === 'broker')
            },
            leadProgress() {
                let totalLeads = this.leads.length;
                let processedLeads = this.leads.filter(lead => lead.isSend).length
                return Math.round((processedLeads / totalLeads) * 100)
            },
            dayOfDay() {
                return dayjs(this.tableTime).format('D MMM')
            },
            weekOfDay() {
                return `${dayjs(this.weekTableTime).startOf('week').format('D MMM')} - ${dayjs(this.weekTableTime).endOf('week').format('D MMM')}`
            },
            monthOfDay() {
                return dayjs(this.monthTableTime).format('MMMM')
            },
            monthLabels() {
                const months = [
                    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
                ];

                return months
            },
            monthValues() {
                const array = []
                let year = dayjs(new Date).format('YYYY')

                for (let i = 0; i < 12; i++) {
                    let monthStartDate = dayjs(`${year}-${String(i + 1).padStart(2, '0')}-01`).format('YYYY-MM-DD');
                    array.push(monthStartDate)
                }

                return array
            }
        },
        methods: {
            resetFilters() {
                this.filterBroker = ""
                this.filterDate = null
                this.filterLeaders = ""
                this.filterIsSend = "qwerty"
            },
            updateWinSize() {
                this.winSize = window.innerWidth
            },
            getDefaultName(string) {
                let someName = string
                if (string.slice(-2) === 'лд') {
                    someName = string.slice(0, -2) + ' ЛД'
                }
                return someName
            },
            async addNewRole() {
                await fetch('/api/role/add', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({'newRole' : this.newRoleInput})
                })
                this.newRoleInput = ""
            },
            async getAllRoles() {
                await fetch('/api/role/getRoles')
                .then(resp => resp.json())
                .then(data => {
                    this.allRoles = data.roles
                })
            },
            downloadLeads() {
                console.log(this.filteredLeads)
                let leadsPhonesArray = []

                this.filteredLeads.forEach((f) => {
                    let phone = f.phone.replace(/\D/g, '')
                    leadsPhonesArray.push(phone)
                })

                console.log(leadsPhonesArray)

                const content = leadsPhonesArray.join('\n');

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'numbers.txt';

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            saveFilters() {

                this.filteredLeads = this.leads.filter(lead => {

                if (this.filterDate) {
                    const leadDate = dayjs(lead.date).format('YYYY-MM-DD')
                    const filterDate = dayjs(this.filterDate).format('YYYY-MM-DD')
                    if (leadDate < filterDate) {
                        return false
                    }
                }
                if (this.filterDateEnd) {
                    const leadDateEnd = dayjs(lead.date).format('YYYY-MM-DD')
                    const filterDateEnd = dayjs(this.filterDateEnd).format('YYYY-MM-DD')
                    if (leadDateEnd > filterDateEnd) {
                        return false
                    }
                }
                if (this.filterBroker != "") {
                    if (lead.broker !== this.filterBroker) {
                        return false
                    }
                }
                if (this.filterLeaders != "") {
                    if (lead.starter !== this.filterLeaders[0] && lead.starter !== this.filterLeaders[1]) {
                        return false
                    }
                }
                if (this.filterIsSend != "qwerty") {
                    if (lead.isSend !== this.filterIsSend) {
                        return false
                    }
                }

                return true;
            });
            },
            fetchLeads() {

                fetch('/api/leads')
                .then(response => response.json())
                .then(data => {
                    data.forEach(e => {
                        e.date = dayjs(e.date).format('YYYY-MM-DD')
                    })
                    this.leads = data;
                    
                    const starters = [];
                    const counts = [];

                    this.leads.forEach((r) => {
                        const starter = r.starter

                        const index = starters.indexOf(starter);
                        
                        if (index === -1) {
                            starters.push(starter);
                            counts.push(1);
                        } else {
                            counts[index]++;
                        }
                    })

                    this.userLeadsArray = starters
                    this.userCountArray = counts

                    this.createChart()

                })
                .catch(error => {
                    console.error('Error:', error);
                });
            },
            fetchUsers() {
                fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    this.users = data;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            },
            createUser() {
                this.newUser['login'] = this.newUser['login'].replace(/\s/g, '').replace(/\//g, '').replace(/\\/g, '').replace(/\t/g, '');
                this.newUser['password'] = this.newUser['password'].replace(/\s/g, '').replace(/\//g, '').replace(/\\/g, '').replace(/\t/g, '');
                this.newUser['name'] = this.newUser['name'].replace(/\s/g, '').replace(/\//g, '').replace(/\\/g, '').replace(/\t/g, '');

                fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.newUser)
                })
                .then(response => {
                    if (response.ok) {
                        this.userMessage = 'User created successfully!';
                        this.newUser = { login: '', password: '', name: '', role: 'leadorub' };
                        this.fetchUsers();
                    } else {
                        this.userMessage = 'Failed to create user.';
                      }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.userMessage = 'Error creating user.';
                });
            },
            beforeUpdateUser(user) {
                this.updatedUserLogin = user.login
                this.updatedUser = user
            },
            updateUser() {
                fetch(`/api/admin/users/${this.updatedUserLogin}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'updatedData' : this.updatedUser
                    })
                })
                .then(response => {
                    if (response.ok) {
                        this.fetchUsers();
                    } else {
                        console.error('Failed to update user');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            },
            deleteUser(login) {
                fetch(`/api/admin/users/${login}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        this.fetchUsers();
                    } else {
                        console.error('Failed to delete user');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            },
            updateLead(index, lead) {
                fetch(`/api/leads/${lead._id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({isSend: lead.isSend})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('Failed to update lead');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            },
            prepareDeleteLead(leadIdx) {
                this.deletingLeadIdx = leadIdx
            },
            deleteLead() {
                fetch(`/api/leads/${this.deletingLeadIdx}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        this.fetchLeads();
                    } else {
                        console.error('Failed to delete lead');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            },
            assignBroker(index, lead) {
                fetch(`/api/leads/${lead._id}`, {
                    method: 'PUT',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ broker: lead.newBroker, isSend: lead.isSend })
                })
              .then(response => {
                if (response.ok) {
                  this.fetchLeads();
                } else {
                  console.error('Failed to assign broker');
                }
              })
              .catch(error => {
                console.error('Error:', error);
              });
            },
            async getCallsSkorozvon() {
                this.tableLoader = true

                try {
                    const response = await fetch(`/skorozvon/get/calls/${dayjs(this.tableTime).format('YYYY-MM-DD')}`, {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    });

                    await this.getSalaryAndBonus()

                } catch (error) {
                    console.error('Ошибка при выполнении запроса или обработке данных:', error);
                } finally {
                    this.tableLoader = false
                }
            },
            async getCallsWeekSkorozvon() {
                try {

                    this.weekDataArrayLoading = true
                    let weekDataArray = []

                    const response = await fetch(`/skorozvon/get/weekCalls/${dayjs(new Date).startOf('week').format('YYYY-MM-DD')}`, {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })

                    await this.getSalaryAndBonusWeek()
                    this.weekDataArrayLoading = false
                } catch (e) {
                    console.log(e)
                }

            },
            async getCallsMonthSkorozvon() {
                try {
                    this.monthDataArrayLoading = true;
                    const startOfMonthStr = dayjs().startOf('month').format('YYYY-MM-DD');
                    const response = await fetch(`/skorozvon/get/monthCalls/${startOfMonthStr}`, {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    });

                    await this.getSalaryAndBonusMonth()
                    this.monthDataArrayLoading = false;
                } catch (e) {
                    console.log(e);
                    this.monthDataArrayLoading = false;
                }
            },
            async getSalaryAndBonus() {
                try {
                    const response = await fetch(`/skorozvon/get/allData/${this.tableTime}`, {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => response.json()).then(data => this.callsData = data)
                } catch (e) {
                    console.log(e)
                }
            },
            async getSalaryAndBonusWeek() {
                try {
                    const response = await fetch(`/skorozvon/get/weeklyData/${dayjs(this.weekTableTime).startOf('week').format('YYYY-MM-DD')}`, {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => response.json()).then(data => this.weekDataArray = data)
                } catch (e) {
                    console.log(e)
                }
            },
            async getSalaryAndBonusMonth() {
                try {
                    const response = await fetch(`/skorozvon/get/monthlyData/${dayjs(this.monthTableTime).startOf('month').format('YYYY-MM-DD')}`, {
                        method: "GET",
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => response.json()).then(data => this.monthDataArray = data)
                } catch (e) {
                    console.log(e)
                }
            },
            changeUserDataShow() {
                this.usersDataShow =! this.usersDataShow
            },
            showSalaryInfo() {
                $('#infoModal').modal('show');
            },
            showBonusInfo() {
                $('#infoModalBonus').modal('show');
            },
            showTotalInfo() {
                $('#infoModalTotal').modal('show');
            },
            createChart() {

                const data = {
                    labels: this.userLeadsArray,
                    datasets: [{
                    label: 'Количество лидов',
                    data: this.userCountArray,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 14
                    }]
                };

                if (this.myChart) {
                    this.myChart.destroy();
                }
                const ctx = this.$refs.myChart.getContext('2d');
                this.myChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        scales: {   
                            y: {
                            beginAtZero: true
                            }
                        },
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                            },
                            title: {
                                display: true,
                                text: 'Ледорубы'
                            }
                        },
                        
                        tooltips: {
                            mode: 'label',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        }
                    }
                })
            }
        }
    });
</script>
</body>
</html>